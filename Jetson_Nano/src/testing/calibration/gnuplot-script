#!/usr/bin/gnuplot
#
# The calibration matrix (affine transformation with offset to origin):
#
# [[  1.09496183   0.1191363  -40.24101047]
#  [  0.1191363    1.14946487  45.03506458]
#  [  0.           0.           1.        ]]
#
# The same matrix, as a Python array:
#
# sensor.calibration = [[1.0949618278189537, 0.11913629789872908, -40.241010471353405], [0.1191362978987291, 1.1494648723914076, 45.03506458466989], [0.0, 0.0, 1.0]]
#
# Invalid semi axes detected: using fit_ellipse() without np.abs().
#
input_data = "magnet-data_20211107_1228.txt"
set output "magnet-data_20211107_1228.png"
circle_size = 1285 * 0.02
raw_data_color = "#28e828"
ellipse_color = "#38a838"
affine_offset_color = "#d0d0d0"
affine_centered_color = "#c020c0"
set term png size 1200, 1200 font "Helvetica,18"
set style line 100 lc rgb raw_data_color lw 1
set style line 300 lc rgb ellipse_color lw 3
set style line 400 lc rgb affine_offset_color lw 3
set style line 500 lc rgb affine_centered_color lw 3
set style fill  transparent solid 0.50
set title "QMC5883L Magnetic Sensor X-Y Plane Calibration"
set size ratio 1
set xzeroaxis
set yzeroaxis
set xrange [-1285:1285]
set yrange [-1285:1285]
set label 40 center at graph 0.5,char 1.5 \
    "Ellipse center (x, y) = (41, -43), Semi-axis (a, b) = (194, 156), Rotation = -38.6Â°"
set bmargin 5
set object 20 ellipse center 41.48,-43.48 size 389.55,313.04 angle -38.56 \
    front fillstyle empty border lc rgb ellipse_color lw 3
set object 10 circle center 41.48,-43.48 size 194.78 \
    front fillstyle empty border lc rgb affine_offset_color lw 3
set object 30 circle center 0,0 size 194.78 \
    front fillstyle empty border lc rgb affine_centered_color lw 3
plot input_data using 1:2:(circle_size) with circles linestyle 100 \
        title "Raw Data", \
    "<echo '41.48 -43.48 193.79 -164.88\n41.48 -43.48 139.04 78.92'" \
        using 1:2:($3-$1):($4-$2) with vectors nohead linestyle 300 \
        title "Best Fit Ellipse", \
    "<echo '41.48 -43.48 209.93 -15.82\n41.48 -43.48 229.23 8.38'" \
        using 1:2:($3-$1):($4-$2) with vectors nohead linestyle 400 \
        title "Affine Transformation from Ellipse to Circle", \
    "<echo '209.93 -15.82\n229.23 8.38'" \
        using 1:2:(circle_size) with circles linestyle 400 \
        title "Transformation: Example Point", \
    "<echo '0 0 187.74 51.86'" \
        using 1:2:($3-$1):($4-$2) with vectors nohead linestyle 500 \
        title "Transformation Circle: Offset to Origin", \
    "<echo '187.74 51.86'" \
        using 1:2:(circle_size) with circles linestyle 500 \
        title "Example Point: Offset to Origin"

